/**
 * OREF IMAGE UPLOADER - Apps Script Web App v4
 * 
 * ACTIONS:
 * - uploadOref: Upload image to Drive
 * - writePrompts: Write prompts with --oref to Sheet C Column I
 * 
 * SETUP:
 * 1. Replace ALL code in your Apps Script with this
 * 2. Deploy → Manage deployments → Edit → New version → Deploy
 */

// Your Oref folder ID
const OREF_FOLDER_ID = '1dWnw-eGmCtj14mfT-ualFkI7o5EdMkXE';

// Story Sheet ID (for writing prompts)
const STORY_SHEET_ID = '1imO5dWALe6aoq-wTgu9sKt4BZ9Nzb3l7D6SrORWb9z0';

/**
 * Handle POST requests
 */
function doPost(e) {
  try {
    Logger.log('Received request');
    
    let data;
    
    // Handle FormData
    if (e.parameter && e.parameter.action) {
      data = e.parameter;
    } else if (e.postData && e.postData.contents) {
      data = JSON.parse(e.postData.contents);
    } else {
      throw new Error('No valid data received');
    }
    
    Logger.log('Action: ' + data.action);
    
    if (data.action === 'uploadOref') {
      return uploadOrefImage(data);
    }
    
    if (data.action === 'writePrompts') {
      return writePromptsToColumnI(data);
    }
    
    return jsonResponse({ success: false, error: 'Unknown action: ' + data.action });
      
  } catch (error) {
    Logger.log('Error: ' + error);
    return jsonResponse({ success: false, error: error.toString() });
  }
}

/**
 * Handle GET requests
 */
function doGet(e) {
  return ContentService
    .createTextOutput('Oref Web App v4 is running.')
    .setMimeType(ContentService.MimeType.TEXT);
}

/**
 * Return JSON response
 */
function jsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Upload oref image to Google Drive
 */
function uploadOrefImage(data) {
  try {
    const storyName = data.storyName;
    const batchId = data.batchId;
    const characterName = data.characterName;
    const imageData = data.imageData;
    
    Logger.log('Uploading oref for: ' + characterName);
    
    // Get or create story folder
    const storyFolderName = batchId ? storyName + ' - ' + batchId : storyName;
    const storyFolder = getOrCreateFolder(OREF_FOLDER_ID, storyFolderName);
    
    // Decode base64 image
    const base64Content = imageData.split(',')[1];
    const imageBlob = Utilities.newBlob(
      Utilities.base64Decode(base64Content),
      'image/png',
      sanitizeFileName(characterName) + '.png'
    );
    
    // Delete existing file if present
    const existingFiles = storyFolder.getFilesByName(imageBlob.getName());
    while (existingFiles.hasNext()) {
      existingFiles.next().setTrashed(true);
    }
    
    // Create the file
    const file = storyFolder.createFile(imageBlob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const publicUrl = 'https://drive.google.com/uc?export=view&id=' + file.getId();
    Logger.log('Uploaded: ' + publicUrl);
    
    return jsonResponse({
      success: true,
      url: publicUrl,
      fileId: file.getId(),
      fileName: file.getName(),
      folderName: storyFolder.getName()
    });
      
  } catch (error) {
    Logger.log('Upload error: ' + error);
    return jsonResponse({ success: false, error: error.toString() });
  }
}

/**
 * Write prompts with --oref to Sheet C Column I
 */
function writePromptsToColumnI(data) {
  try {
    const prompts = JSON.parse(data.prompts);
    Logger.log('Writing ' + prompts.length + ' prompts');
    
    const ss = SpreadsheetApp.openById(STORY_SHEET_ID);
    const sheet = ss.getSheetByName('Midjounrey Ready character/object description_C');
    
    if (!sheet) {
      throw new Error('Sheet C not found');
    }
    
    let written = 0;
    
    for (const p of prompts) {
      // Write to Column I (column 9) at the specified row
      sheet.getRange(p.row, 9).setValue(p.prompt);
      written++;
    }
    
    Logger.log('Written ' + written + ' prompts');
    
    return jsonResponse({
      success: true,
      written: written
    });
      
  } catch (error) {
    Logger.log('Write error: ' + error);
    return jsonResponse({ success: false, error: error.toString() });
  }
}

/**
 * Get or create a folder
 */
function getOrCreateFolder(parentFolderId, folderName) {
  const parentFolder = DriveApp.getFolderById(parentFolderId);
  const folders = parentFolder.getFoldersByName(folderName);
  
  if (folders.hasNext()) {
    return folders.next();
  }
  
  return parentFolder.createFolder(folderName);
}

/**
 * Sanitize filename
 */
function sanitizeFileName(name) {
  return name
    .replace(/[^a-zA-Z0-9_\-]/g, '_')
    .replace(/_+/g, '_')
    .replace(/^_|_$/g, '');
}
